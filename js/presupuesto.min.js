function veoPresupuesto(a){var b=a.toString();$("#presupuesto-visualizado").empty(),$(".presupuestosAnteriores button").css("display","none");try{$("#tooltip").remove()}catch(c){console.log(c)}switch(b){case"2014":$(".titulo h3").text("¿Cómo se distribuyen los $59 mil millones de la Ciudad?"),presupuesto("data/presupuesto2014.csv",6,6,["#ECD078","#D95B43","#C02942","#542437","#53777A"],170),$("#a2015").css("display","inline");break;case"2015":$(".titulo h3").text("¿Cómo se distribuyen los $86 mil millones de la Ciudad?"),presupuesto("data/presupuesto2015.csv",6,8,["#ECD078","#D95B43","#C02942","#542437","#53777A","#c1dd53"],110),$("#a2014").css("display","inline")}$("#selectedYear").text(b)}function presupuesto(a,b,c,d,e){function f(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=0,g=1.1,h=c.attr("y"),i=c.attr("x"),j=parseFloat(c.attr("dy")),k=c.text(null).append("tspan").attr("x",i).attr("y",h).attr("dy",j+"em");a=d.pop();)e.push(a),k.text(e.join(" ")),k.node().getComputedTextLength()>b&&(e.pop(),k.text(e.join(" ")),e=[a],k=c.append("tspan").attr("y",h).attr("x",i).attr("dy",++f*g+j+"em").text(a))})}function g(a){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var b=/(\d+)(\d{3})/;b.test(x1);)x1=x1.replace(b,"$1,$2");return x1+x2}var h,i,j;i=$("#contenedor-visualizacion"),j=$(".referencias"),d3.csv(a,function(a){var l=[],m=[],n=[],o=[],p=[],q=[];a.forEach(function(a){l.indexOf(a.jurisdiccion)<0&&(l.push(a.jurisdiccion),q.push(0)),m.indexOf(a.id_jurisdiccion)<0&&m.push(a.id_jurisdiccion),n.indexOf(a.finalidad)<0&&(n.push(a.finalidad),p.push(0)),o.indexOf(a.id_finalidad)<0&&o.push(a.id_finalidad),p[n.indexOf(a.finalidad)]=parseInt(p[n.indexOf(a.finalidad)])+parseInt(a.monto),q[l.indexOf(a.jurisdiccion)]=parseInt(q[l.indexOf(a.jurisdiccion)])+parseInt(a.monto)});for(var r=[],s=0;s<n.length;s++)r[s]=[n[s],p[s],o[s]];r.sort(function(a,b){return d3.descending(a[1],b[1])});for(var t=[],s=0;s<l.length;s++)t[s]=[l[s],q[s],m[s]];t.sort(function(a,b){return d3.descending(a[1],b[1])}),h=function(a,h){"use strict";function m(a){var b=40;return 1===a?I/V*a+100:I/V*a+100+a*b}function o(b){var c=a.max(b,function(a){return parseInt(a.monto,10)}),d=a.scale.linear().domain([0,c]).range([O,P]);b.forEach(function(a){var b={id:a.id_jurisdiccion,radius:d(parseInt(a.monto,10)),monto:a.monto,jurisdiccion:a.jurisdiccion,id_jurisdiccion:a.id_jurisdiccion,finalidad:a.finalidad,id_finalidad:a.id_finalidad,funcion:a.funcion,id_funcion:a.id_funcion,x:Math.random()*H,y:Math.random()*I};N.push(b)}),N.sort(function(a,b){return b.monto-a.monto}),E=a.select("#presupuesto-visualizado").append("svg").attr("width",H),G=E.selectAll("circle").data(N).enter().append("circle").attr("r",0).style("opacity",.9).attr("fill",function(a){return Z(a.finalidad)}).attr("stroke-width",1.5).attr("stroke",function(b){return a.rgb(Z(b.finalidad)).darker()}).attr("id",function(a){return"bubble_"+a.id_finalidad}).on("mouseover",function(b,c){var d=a.select(this);d.style("stroke-width",3),d.style("opacity",.9),C(b,c,this)}).on("mouseout",function(b,c){D(b,c,this);var d=a.select(this);d.style("stroke-width",1.5),d.style("opacity",function(){return $("#jurisdiccion").hasClass("disabled")?.3:.9})}),G.transition().duration(1500).attr("r",function(a){return a.radius})}function p(a){return a.value<0?0:-Math.pow(a.radius,1.9)}function q(){F=a.layout.force().nodes(N).size([H,I])}function s(){F.gravity(K).charge(p).friction(L).on("tick",function(a){G.each(u(a.alpha)).attr("fill",function(a){return Z(a.finalidad)}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("opacity",.9)}),F.start(),B()}function u(a){return function(b){b.x=b.x+(R.x-b.x)*(M+.02)*a,b.y=b.y+(R.y-b.y)*(M+.02)*a}}function v(){F.gravity(-.01).charge(p).friction(.5).on("tick",function(a){G.each(w(a.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("fill","#FFF")}),F.start(),A()}function w(a){return function(b){var c=X[b.id_jurisdiccion];try{b.x=b.x+(c.x-b.x)*(M+.02)*a*1.2,b.y=b.y+(c.y-b.y)*(M+.02)*a*1.2}catch(d){console.log(d)}}}function x(){F.gravity(K).charge(p).friction(.9).on("tick",function(a){G.each(y(a.alpha)).attr("fill",function(a){return Z(a.finalidad)}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("opacity",.9)}),F.start(),z()}function y(a){return function(b){var c=S[b.id_finalidad];b.x=b.x+(c.x-b.x)*(M+.02)*a*1.2,b.y=b.y+(c.y-b.y)*(M+.02)*a*1.2}}function z(){B();var b=S,c=a.keys(b),d=E.append("g").classed("finalidad",!0).attr("transform","translate(0,"+(I-90)+")").selectAll(".finalidad").data(c);d.enter().append("text").style("opacity",0).attr("class","titulo").attr("x",function(a){return b[a].x}).attr("dy","3em").attr("y",-20).attr("text-wrap","normal").attr("text-anchor","middle").text(function(a){return b[a].id}).call(f,130).transition().duration(500).style("opacity",1),d.enter().append("text").style("opacity",0).attr("class","total").attr("x",function(a){return b[a].x}).attr("y",0).attr("text-wrap","normal").attr("text-anchor","middle").text(function(a){return"$"+Q(b[a].monto)}).transition().duration(750).style("opacity",1)}function A(){B();var b=X,c=a.keys(X),d=E.append("g").classed("jurisdiccion",!0).attr("transform","translate(0,0)").selectAll(".jurisdiccion").data(c);d.enter().append("text").style("opacity",0).attr("class","titulo").attr("x",function(a){return b[a].x}).attr("dy","3em").attr("y",function(a){return b[a].y-20}).style("pointer-events","none").attr("text-wrap","normal").attr("text-anchor","middle").text(function(a){return b[a].id}).call(f,130).transition().duration(500).style("opacity",1),d.enter().append("text").style("opacity",0).attr("class","total").attr("x",function(a){return b[a].x}).attr("y",function(a){return b[a].y}).style("pointer-events","none").attr("text-wrap","normal").attr("text-anchor","middle").text(function(a){return"$"+Q(b[a].monto)}).transition().duration(750).style("opacity",1)}function B(){E.selectAll(".finalidad").remove(),E.selectAll(".jurisdiccion").remove()}function C(b,c,d){a.select(d).attr("stroke","black");var e='<span class="name">Finalidad:</span><span class="value"> '+b.finalidad+"</span><br/>";e+='<span class="name">Función:</span><span class="value"> '+b.funcion+"</span><br/>",e+='<span class="name">Jurisdicción:</span><span class="value"> '+b.jurisdiccion+"</span><br/>",e+='<span class="name">Monto:</span><span class="value"> $'+g(Q(b.monto))+"</span>",J.showTooltip(e,a.event)}function D(b,c,d){a.select(d).attr("stroke",function(b){return a.rgb(Z(b.finalidad)).darker()}),J.hideTooltip()}for(var E,F,G,H=1200,I=600,J=h("tooltip",300),K=-.01,L=.9,M=.45,N=[],O=3,P=70,Q=function(a){return k(1*a)},R={x:H/2,y:I/2},S={},T=0;T<n.length;T++)S[parseInt(r[T][2])]={id:r[T][0],monto:r[T][1],x:(T+1)*H/b,y:I/2};for(var U=4,V=c,W=250,X={},Y=[1,1],T=0;T<l.length;T++)X[parseInt(t[T][2])]={id:t[T][0],monto:t[T][1],x:Y[0]*(H-W)/U,y:m(Y[1])},Y[0]++,5===Y[0]&&(Y[0]=1,Y[1]++);var Z=a.scale.ordinal().domain(n).range(d);a.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var _={};return _.init=function(a){o(a),q()},_.cambiarVista=function(a){"finalidad"==a?(x(),i.delay(200).animate({height:600},1e3),j.animate({opacity:0},250)):"jurisdiccion"==a?(v(),G.style("opacity",.3),i.animate({height:e*V},500),j.animate({opacity:0},250)):(s(),i.delay(200).animate({height:600},1e3),j.delay(300).animate({opacity:1},350))},_}(d3,CustomTooltip),h.init(a);var u=$(location).attr("href");"/total"==u.split("#")[1]?($("#seleccion a").removeClass("disabled"),$("#total").toggleClass("disabled"),h.cambiarVista("total")):"/finalidad"==u.split("#")[1]?($("#seleccion a").removeClass("disabled"),$("#finalidad").toggleClass("disabled"),h.cambiarVista("finalidad")):"/jurisdiccion"==u.split("#")[1]?($("#seleccion a").removeClass("disabled"),$("#jurisdiccion").toggleClass("disabled"),h.cambiarVista("jurisdiccion")):h.cambiarVista("total")});var k=function(a,b){var c,d,e,f,g,h,i;return i="",f="",g="",a>=1e9?(i=" mil millones",a/=1e9,b=1):a>=1e6?(i=" millones",a/=1e6,b=1):a>=1e5&&(i="",a/=1e5,b=1),h="",b>0?(1>a&&(h="0"),c=String(Math.round(a*Math.pow(10,b))),10>c?(d="0"+c.substr(c.length-b,b),e=""):(d=c.substr(c.length-b,b),e=c.substr(0,c.length-b)),f+h+e.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")+"."+d+i+g):(c=String(Math.round(a)),c=c.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),f+c+i+g)};$(document).ready(function(){$("#seleccion a").click(function(){var a=$(this).attr("id");return window.location="#/"+a,$("#seleccion a").removeClass("disabled"),$(this).toggleClass("disabled"),h.cambiarVista(a),!1})})}veoPresupuesto(2015);