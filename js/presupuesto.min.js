var custom_bubble_chart,container,referencias;container=$("#contenedor-visualizacion");referencias=$(".referencias");d3.csv("data/presupuesto.csv",function(e){var a=[];var j=[];var h=[];var k=[];var b=[];var g=[];e.forEach(function(i){if(a.indexOf(i.jurisdiccion)<0){a.push(i.jurisdiccion);g.push(0)}if(j.indexOf(i.id_jurisdiccion)<0){j.push(i.id_jurisdiccion)}if(h.indexOf(i.finalidad)<0){h.push(i.finalidad);b.push(0)}if(k.indexOf(i.id_finalidad)<0){k.push(i.id_finalidad)}b[h.indexOf(i.finalidad)]=parseInt(b[h.indexOf(i.finalidad)])+parseInt(i.monto);g[a.indexOf(i.jurisdiccion)]=parseInt(g[a.indexOf(i.jurisdiccion)])+parseInt(i.monto)});var f=[];for(var d=0;d<h.length;d++){f[d]=[h[d],b[d],k[d]]}f.sort(function(l,i){return d3.descending(l[1],i[1])});var c=[];for(var d=0;d<a.length;d++){c[d]=[a[d],g[d],j[d]]}c.sort(function(l,i){return d3.descending(l[1],i[1])});custom_bubble_chart=(function(S,N){var l=1200,n=600,J=N("tooltip",300),v=-0.01,B=0.9,L=0.45,M=[],u=3,H=110,U,o,r,z,F=function(i){return formatNumber(i*1)};var m={x:l/2,y:n/2};var I={};for(var W=0;W<h.length;W++){I[parseInt(f[W][2])]={id:f[W][0],monto:f[W][1],x:(W+1)*l/6,y:n/2}}var V=4;var P=6;var p=250;var E={};var T=[1,1];for(var W=0;W<a.length;W++){E[parseInt(c[W][2])]={id:c[W][0],monto:c[W][1],x:T[0]*(l-p)/V,y:(n/P)*T[1]+100};T[0]++;if(T[0]===5){T[0]=1;T[1]++}}console.log(E);var q=S.scale.ordinal().domain(h).range(["#ECD078","#D95B43","#C02942","#542437","#53777A"]);function K(i){var ab=S.max(i,function(ac){return parseInt(ac.monto,10)}),aa=S.scale.linear().domain([0,ab]).range([u,H]);i.forEach(function(ad){var ac={id:ad.id_jurisdiccion,radius:aa(parseInt(ad.monto,10)),monto:ad.monto,jurisdiccion:ad.jurisdiccion,id_jurisdiccion:ad.id_jurisdiccion,finalidad:ad.finalidad,id_finalidad:ad.id_finalidad,funcion:ad.funcion,id_funcion:ad.id_funcion,x:Math.random()*l,y:Math.random()*n};M.push(ac)});M.sort(function(ad,ac){return ac.monto-ad.monto});U=S.select("#presupuesto-visualizado").append("svg").attr("width",l);r=U.selectAll("circle").data(M).enter().append("circle").attr("r",0).style("opacity",0.9).attr("fill",function(ac){return q(ac.finalidad)}).attr("stroke-width",1.5).attr("stroke",function(ac){return S.rgb(q(ac.finalidad)).darker()}).attr("id",function(ac){return"bubble_"+ac.id_finalidad}).on("mouseover",function(ae,ac){var ad=S.select(this);ad.style("stroke-width",3);ad.style("opacity",1);A(ae,ac,this)}).on("mouseout",function(ae,ac){Z(ae,ac,this);var ad=S.select(this);ad.style("stroke-width",1.5);ad.style("opacity",0.9)});r.transition().duration(1500).attr("r",function(ac){return ac.radius})}S.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};function G(i){if(i.value<0){return 0}else{return -Math.pow(i.radius,1.9)}}function C(){o=S.layout.force().nodes(M).size([l,n])}function y(){o.gravity(v).charge(G).friction(B).on("tick",function(i){r.each(Y(i.alpha)).attr("fill",function(aa){return q(aa.finalidad)}).attr("cx",function(aa){return aa.x}).attr("cy",function(aa){return aa.y}).style("opacity",1)});o.start();t()}function Y(i){return function(aa){aa.x=aa.x+(m.x-aa.x)*(L+0.02)*i;aa.y=aa.y+(m.y-aa.y)*(L+0.02)*i}}function R(){o.gravity(-0.01).charge(G).friction(0.5).on("tick",function(i){r.each(O(i.alpha)).attr("cx",function(aa){return aa.x}).attr("cy",function(aa){return aa.y}).attr("fill","#FFF").style("opacity",0.3)});o.start();s()}function O(i){return function(ab){var aa=E[ab.id_jurisdiccion];ab.x=ab.x+(aa.x-ab.x)*(L+0.02)*i*1.2;ab.y=ab.y+(aa.y-ab.y)*(L+0.02)*i*1.2}}function X(){o.gravity(v).charge(G).friction(0.9).on("tick",function(i){r.each(w(i.alpha)).attr("fill",function(aa){return q(aa.finalidad)}).attr("cx",function(aa){return aa.x}).attr("cy",function(aa){return aa.y}).style("opacity",1)});o.start();D()}function w(i){return function(ab){var aa=I[ab.id_finalidad];ab.x=ab.x+(aa.x-ab.x)*(L+0.02)*i*1.2;ab.y=ab.y+(aa.y-ab.y)*(L+0.02)*i*1.2}}function D(){t();var ab=I;var aa=S.keys(ab);var i=U.append("g").classed("finalidad",true).attr("transform","translate(0,"+(n-90)+")").selectAll(".finalidad").data(aa);i.enter().append("text").style("opacity",0).attr("class","titulo").attr("x",function(ac){return ab[ac].x}).attr("dy","3em").attr("y",-20).attr("text-wrap","normal").attr("text-anchor","middle").text(function(ac){return ab[ac].id}).call(wrap,130).transition().duration(500).style("opacity",1);i.enter().append("text").style("opacity",0).attr("class","total").attr("x",function(ac){return ab[ac].x}).attr("y",0).attr("text-wrap","normal").attr("text-anchor","middle").text(function(ac){return"$"+F(ab[ac].monto)}).transition().duration(750).style("opacity",1)}function s(){t();var ab=E;var aa=S.keys(E);var i=U.append("g").classed("jurisdiccion",true).attr("transform","translate(0,"+0+")").selectAll(".jurisdiccion").data(aa);i.enter().append("text").style("opacity",0).attr("class","titulo").attr("x",function(ac){return ab[ac].x}).attr("dy","3em").attr("y",function(ac){return ab[ac].y-20}).style("pointer-events","none").attr("text-wrap","normal").attr("text-anchor","middle").text(function(ac){return ab[ac].id}).call(wrap,130).transition().duration(500).style("opacity",1);i.enter().append("text").style("opacity",0).attr("class","total").attr("x",function(ac){return ab[ac].x}).attr("y",function(ac){return ab[ac].y}).style("pointer-events","none").attr("text-wrap","normal").attr("text-anchor","middle").text(function(ac){return"$"+F(ab[ac].monto)}).transition().duration(750).style("opacity",1)}function t(){var i=U.selectAll(".finalidad").remove();var aa=U.selectAll(".jurisdiccion").remove()}function A(ad,ab,aa){S.select(aa).attr("stroke","black");var ac='<span class="name">Finalidad:</span><span class="value"> '+ad.finalidad+"</span><br/>";ac+='<span class="name">Función:</span><span class="value"> '+ad.funcion+"</span><br/>";ac+='<span class="name">Jurisdicción:</span><span class="value"> '+ad.jurisdiccion+"</span><br/>";ac+='<span class="name">Monto:</span><span class="value"> $'+addCommas(F(ad.monto))+"</span>";J.showTooltip(ac,S.event)}function Z(ac,ab,aa){S.select(aa).attr("stroke",function(i){return S.rgb(q(i.finalidad)).darker()});J.hideTooltip()}var Q={};Q.init=function(i){K(i);C()};Q.cambiarVista=function(i){if(i=="finalidad"){X();container.delay(200).animate({height:600},1000);referencias.animate({opacity:0},250)}else{if(i=="jurisdiccion"){R();container.animate({height:900},500);referencias.animate({opacity:0},250)}else{y();container.delay(200).animate({height:600},1000);referencias.delay(300).animate({opacity:1},350)}}};return Q})(d3,CustomTooltip);custom_bubble_chart.init(e);custom_bubble_chart.cambiarVista("todo")});function wrap(b,a){b.each(function(){var j=d3.select(this),e=j.text().split(/\s+/).reverse(),c,l=[],d=0,i=1.1,g=j.attr("y"),h=j.attr("x"),k=parseFloat(j.attr("dy")),f=j.text(null).append("tspan").attr("x",h).attr("y",g).attr("dy",k+"em");while(c=e.pop()){l.push(c);f.text(l.join(" "));if(f.node().getComputedTextLength()>a){l.pop();f.text(l.join(" "));l=[c];f=j.append("tspan").attr("y",g).attr("x",h).attr("dy",++d*i+k+"em").text(c)}}})}function addCommas(b){b+="";x=b.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";var a=/(\d+)(\d{3})/;while(a.test(x1)){x1=x1.replace(a,"$1,$2")}return x1+x2}var formatNumber=function(b,c){var i,h,d,a,f,e,g;g="";a="";f="";if(b>=1000000000){g=" mil millones";b=b/1000000000;c=1}else{if(b>=1000000){g=" millones";b=b/1000000;c=1}else{if(b>=100000){g="";b=b/100000;c=1}}}e="";if(c>0){if(b<1){e="0"}i=String(Math.round(b*(Math.pow(10,c))));if(i<10){h="0"+i.substr(i.length-(c),c);d=""}else{h=i.substr(i.length-(c),c);d=i.substr(0,i.length-c)}return a+e+d.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")+"."+h+g+f}else{i=String(Math.round(b));i=i.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,");return a+i+g+f}};$(document).ready(function(){$("#seleccion a").click(function(){var a=$(this).attr("id");$("#seleccion a").removeClass("disabled");$(this).toggleClass("disabled");custom_bubble_chart.cambiarVista(a);return false})});
