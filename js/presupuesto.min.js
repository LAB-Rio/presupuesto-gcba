function wrap(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=0,g=1.1,h=c.attr("y"),i=c.attr("x"),j=parseFloat(c.attr("dy")),k=c.text(null).append("tspan").attr("x",i).attr("y",h).attr("dy",j+"em");a=d.pop();)e.push(a),k.text(e.join(" ")),k.node().getComputedTextLength()>b&&(e.pop(),k.text(e.join(" ")),e=[a],k=c.append("tspan").attr("y",h).attr("x",i).attr("dy",++f*g+j+"em").text(a))})}function addCommas(a){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var b=/(\d+)(\d{3})/;b.test(x1);)x1=x1.replace(b,"$1,$2");return x1+x2}var custom_bubble_chart,container,referencias;container=$("#contenedor-visualizacion"),referencias=$(".referencias"),d3.csv("data/presupuesto.csv",function(a){var b=[],c=[],d=[],e=[],f=[],g=[];a.forEach(function(a){b.indexOf(a.jurisdiccion)<0&&(b.push(a.jurisdiccion),g.push(0)),c.indexOf(a.id_jurisdiccion)<0&&c.push(a.id_jurisdiccion),d.indexOf(a.finalidad)<0&&(d.push(a.finalidad),f.push(0)),e.indexOf(a.id_finalidad)<0&&e.push(a.id_finalidad),f[d.indexOf(a.finalidad)]=parseInt(f[d.indexOf(a.finalidad)])+parseInt(a.monto),g[b.indexOf(a.jurisdiccion)]=parseInt(g[b.indexOf(a.jurisdiccion)])+parseInt(a.monto)});for(var h=[],i=0;i<d.length;i++)h[i]=[d[i],f[i],e[i]];h.sort(function(a,b){return d3.descending(a[1],b[1])});for(var j=[],i=0;i<b.length;i++)j[i]=[b[i],g[i],c[i]];j.sort(function(a,b){return d3.descending(a[1],b[1])}),custom_bubble_chart=function(a,c){"use strict";function e(b){var c=a.max(b,function(a){return parseInt(a.monto,10)}),d=a.scale.linear().domain([0,c]).range([E,F]);b.forEach(function(a){var b={id:a.id_jurisdiccion,radius:d(parseInt(a.monto,10)),monto:a.monto,jurisdiccion:a.jurisdiccion,id_jurisdiccion:a.id_jurisdiccion,finalidad:a.finalidad,id_finalidad:a.id_finalidad,funcion:a.funcion,id_funcion:a.id_funcion,x:Math.random()*x,y:Math.random()*y};D.push(b)}),D.sort(function(a,b){return b.monto-a.monto}),u=a.select("#presupuesto-visualizado").append("svg").attr("width",x),w=u.selectAll("circle").data(D).enter().append("circle").attr("r",0).style("opacity",.9).attr("fill",function(a){return P(a.finalidad)}).attr("stroke-width",1.5).attr("stroke",function(b){return a.rgb(P(b.finalidad)).darker()}).attr("id",function(a){return"bubble_"+a.id_finalidad}).on("mouseover",function(b,c){var d=a.select(this);d.style("stroke-width",3),d.style("opacity",1),s(b,c,this)}).on("mouseout",function(b,c){t(b,c,this);var d=a.select(this);d.style("stroke-width",1.5),d.style("opacity",.9)}),w.transition().duration(1500).attr("r",function(a){return a.radius})}function f(a){return a.value<0?0:-Math.pow(a.radius,1.9)}function g(){v=a.layout.force().nodes(D).size([x,y])}function i(){v.gravity(A).charge(f).friction(B).on("tick",function(a){w.each(k(a.alpha)).attr("fill",function(a){return P(a.finalidad)}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("opacity",1)}),v.start(),r()}function k(a){return function(b){b.x=b.x+(H.x-b.x)*(C+.02)*a,b.y=b.y+(H.y-b.y)*(C+.02)*a}}function l(){v.gravity(-.01).charge(f).friction(.5).on("tick",function(a){w.each(m(a.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("opacity",.3)}),v.start(),q()}function m(a){return function(b){var c=N[b.id_jurisdiccion];console.log(c.y),b.x=b.x+(c.x-b.x)*(C+.02)*a*1.2,b.y=b.y+(c.y-b.y)*(C+.02)*a*1.2}}function n(){v.gravity(A).charge(f).friction(.9).on("tick",function(a){w.each(o(a.alpha)).attr("fill",function(a){return P(a.finalidad)}).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).style("opacity",1)}),v.start(),p()}function o(a){return function(b){var c=I[b.id_finalidad];b.x=b.x+(c.x-b.x)*(C+.02)*a*1.2,b.y=b.y+(c.y-b.y)*(C+.02)*a*1.2}}function p(){r();var b=I,c=a.keys(b),d=u.append("g").classed("finalidad",!0).attr("transform","translate(0,"+(y-90)+")").selectAll(".finalidad").data(c);d.enter().append("text").style("opacity",0).attr("class","titulo").attr("x",function(a){return b[a].x}).attr("dy","3em").attr("y",-20).attr("text-wrap","normal").attr("text-anchor","middle").text(function(a){return b[a].id}).call(wrap,130).transition().duration(500).style("opacity",1),d.enter().append("text").style("opacity",0).attr("class","total").attr("x",function(a){return b[a].x}).attr("y",0).attr("text-wrap","normal").attr("text-anchor","middle").text(function(a){return"$"+G(b[a].monto)}).transition().duration(750).style("opacity",1)}function q(){r();var b=N,c=a.keys(N),d=u.append("g").classed("jurisdiccion",!0).attr("transform","translate(0,0)").selectAll(".jurisdiccion").data(c);d.enter().append("text").style("opacity",0).attr("class","titulo").attr("x",function(a){return b[a].x}).attr("dy","3em").attr("y",function(a){return b[a].y-20}).style("pointer-events","none").attr("text-wrap","normal").attr("text-anchor","middle").text(function(a){return b[a].id}).call(wrap,130).transition().duration(500).style("opacity",1),d.enter().append("text").style("opacity",0).attr("class","total").attr("x",function(a){return b[a].x}).attr("y",function(a){return b[a].y}).style("pointer-events","none").attr("text-wrap","normal").attr("text-anchor","middle").text(function(a){return"$"+G(b[a].monto)}).transition().duration(750).style("opacity",1)}function r(){u.selectAll(".finalidad").remove(),u.selectAll(".jurisdiccion").remove()}function s(b,c,d){a.select(d).attr("stroke","black");var e='<span class="name">Finalidad:</span><span class="value"> '+b.finalidad+"</span><br/>";e+='<span class="name">Función:</span><span class="value"> '+b.funcion+"</span><br/>",e+='<span class="name">Jurisdicción:</span><span class="value"> '+b.jurisdiccion+"</span><br/>",e+='<span class="name">Monto:</span><span class="value"> $'+addCommas(G(b.monto))+"</span>",z.showTooltip(e,a.event)}function t(b,c,d){a.select(d).attr("stroke",function(b){return a.rgb(P(b.finalidad)).darker()}),z.hideTooltip()}for(var u,v,w,x=1200,y=600,z=c("tooltip",300),A=-.01,B=.9,C=.45,D=[],E=3,F=110,G=function(a){return formatNumber(1*a)},H={x:x/2,y:y/2},I={},J=0;J<d.length;J++)I[parseInt(h[J][2])]={id:h[J][0],monto:h[J][1],x:(J+1)*x/6,y:y/2};for(var K=4,L=6,M=250,N={},O=[1,1],J=0;J<b.length;J++)N[parseInt(j[J][2])]={id:j[J][0],monto:j[J][1],x:O[0]*(x-M)/K,y:y/L*O[1]+100+150*O[1]},O[0]++,5===O[0]&&(O[0]=1,O[1]++);var P=a.scale.ordinal().domain(d).range(["#ECD078","#D95B43","#C02942","#542437","#53777A"]);a.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var Q={};return Q.init=function(a){e(a),g()},Q.cambiarVista=function(a){"finalidad"==a?(n(),container.delay(200).animate({height:600},1e3),referencias.animate({opacity:0},250)):"jurisdiccion"==a?(l(),container.animate({height:900},500),referencias.animate({opacity:0},250)):(i(),container.delay(200).animate({height:600},1e3),referencias.delay(300).animate({opacity:1},350))},Q}(d3,CustomTooltip),custom_bubble_chart.init(a),custom_bubble_chart.cambiarVista("todo")});var formatNumber=function(a,b){var c,d,e,f,g,h,i;return i="",f="",g="",a>=1e9?(i=" mil millones",a/=1e9,b=1):a>=1e6?(i=" millones",a/=1e6,b=1):a>=1e5&&(i="",a/=1e5,b=1),h="",b>0?(1>a&&(h="0"),c=String(Math.round(a*Math.pow(10,b))),10>c?(d="0"+c.substr(c.length-b,b),e=""):(d=c.substr(c.length-b,b),e=c.substr(0,c.length-b)),f+h+e.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")+"."+d+i+g):(c=String(Math.round(a)),c=c.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),f+c+i+g)};$(document).ready(function(){$("#seleccion a").click(function(){var a=$(this).attr("id");return $("#seleccion a").removeClass("disabled"),$(this).toggleClass("disabled"),custom_bubble_chart.cambiarVista(a),!1})});